import os
import glob
import re
import pandas as pd
import numpy as np

# --- Configuration ---
# ⚠️ IMPORTANT: Update the 'folder_to_analyze' path below.
folder_to_analyze = r"" # Assumes files are in the current working directory for simple execution

# Parameters from your prompt 
PARTICLE_DENSITY = 900.0 # kg/m^3
PARTICLE_RADIUS = 0.02   # m
TIME_PER_FRAME = 0.2     # seconds

# Thresholds
# The lower Y threshold for the exit (m).
Y_THRESHOLD_EXIT = 0.8 
# Set this to a higher Y value (closer to the simulation domain top) to track input flow.
Y_THRESHOLD_INPUT = 1.2

# Frame Range Variables for MFR Calculation
START_FRAME = 40      
END_FRAME = 9999     


# Helper function to calculate MFR for a specific set of counts
def calculate_mfr_metrics(frame_counts, mfr_frames, particle_mass, time_per_frame, KG_S_TO_T_H_FACTOR):
    """Calculates MFR and related metrics for a given set of frame particle counts."""
    num_frames_in_range = len(mfr_frames)
    
    if num_frames_in_range < 2:
        return {
            'time_for_mfr': 0.0,
            'total_particles_passed_in_range': 0,
            'accumulated_count_end': 0,
            'average_mfr_kg_s': 0.0,
            'average_mfr_t_h': 0.0
        }

    start_frame_in_range = mfr_frames[0]
    final_frame_in_range = mfr_frames[-1]
    
    start_count = frame_counts[start_frame_in_range]
    accumulated_count_end = frame_counts[final_frame_in_range]
    
    # Total particles that passed *during* the analysis window (the change/difference)
    total_particles_passed_in_range = accumulated_count_end - start_count
    
    # MFR Calculation: based on the change in mass over the change in time
    mass_passed_in_range = total_particles_passed_in_range * particle_mass
    
    # Total time is (Number of intervals) * time_per_frame
    time_for_mfr = (num_frames_in_range - 1) * time_per_frame
    
    if time_for_mfr > 0:
        average_mfr_kg_s = mass_passed_in_range / time_for_mfr
    else:
        average_mfr_kg_s = 0.0
        
    average_mfr_t_h = average_mfr_kg_s * KG_S_TO_T_H_FACTOR

    return {
        'time_for_mfr': time_for_mfr,
        'total_particles_passed_in_range': total_particles_passed_in_range,
        'accumulated_count_end': accumulated_count_end,
        'average_mfr_kg_s': average_mfr_kg_s,
        'average_mfr_t_h': average_mfr_t_h
    }

def calculate_mass_flow_rate_from_vtk(folder_path, y_threshold_exit, y_threshold_input, particle_density, particle_radius, time_per_frame, start_frame, end_frame):
    """
    Analyzes VTK particle files to calculate the mass flow rate (MFR) 
    at both an input (higher y) and exit (lower y) threshold.
    """
    
    KG_S_TO_T_H_FACTOR = 3.6
    V = (4/3) * np.pi * (particle_radius**3)
    particle_mass = particle_density * V
    
    print(f"--- Analysis Parameters ---")
    print(f"Single Particle Mass: {particle_mass:.6f} kg")
    print(f"Exit Y-Threshold: {y_threshold_exit} m")
    print(f"Input Y-Threshold: {y_threshold_input} m")
    print(f"MFR Calculation Range: Frames {start_frame} to {end_frame}")
    print("-" * 30)

    # 1. File Identification and Sorting
    file_pattern = os.path.join(folder_path, "frame_[0-9][0-9][0-9][0-9]_particles.vtk")
    vtk_files = glob.glob(file_pattern)
    
    if not vtk_files:
        print(f"Error: No files matching 'frame_xxxx_particles.vtk' found in {folder_path}")
        return False

    def extract_frame_number(filepath):
        match = re.search(r'frame_(\d+)_particles\.vtk', os.path.basename(filepath))
        return int(match.group(1)) if match else -1

    vtk_files.sort(key=extract_frame_number)
    
    # 2. Data Extraction and Processing (For ALL Frames)
    data_exit_y_values = {} # Only store sorted Y-values for the primary EXIT data
    frame_counts_exit = {}
    frame_counts_input = {}
    
    for file_path in vtk_files:
        frame_num = extract_frame_number(file_path)
        y_values_below_exit = []
        count_input = 0 # Temp count for input threshold
        
        try:
            with open(file_path, 'r') as f:
                in_points_section = False
                for line in f:
                    if line.strip().startswith('POINTS'):
                        in_points_section = True
                        continue
                    if line.strip().startswith('CELLS') or line.strip().startswith('POINT_DATA'):
                        in_points_section = False
                        
                    if in_points_section:
                        try:
                            coords = [float(c) for c in line.strip().split()]
                            if len(coords) >= 3:
                                y = coords[1]
                                
                                # Count for EXIT (Lower threshold)
                                if y < y_threshold_exit:
                                    y_values_below_exit.append(y)
                                
                                # Count for INPUT (Higher threshold)
                                if y < y_threshold_input:
                                    count_input += 1
                                    
                        except ValueError:
                            continue

            # Store data for full Excel output
            y_values_below_exit.sort()
            data_exit_y_values[f'Frame {frame_num}'] = y_values_below_exit
            
            # Store counts for MFR calculation
            frame_counts_exit[frame_num] = len(y_values_below_exit)
            frame_counts_input[frame_num] = count_input
            
        except Exception as e:
            print(f"Error processing file {file_path}: {e}")
            continue

    # 3. MFR Calculation (Only using specified range)
    mfr_frames = sorted([f for f in frame_counts_exit.keys() if start_frame <= f <= end_frame])
    
    # Calculate MFR metrics for both input and exit
    input_mfr_metrics = calculate_mfr_metrics(frame_counts_input, mfr_frames, particle_mass, time_per_frame, KG_S_TO_T_H_FACTOR)
    exit_mfr_metrics = calculate_mfr_metrics(frame_counts_exit, mfr_frames, particle_mass, time_per_frame, KG_S_TO_T_H_FACTOR)
    
    
    print(f"\n--- Results for MFR Calculation Range {mfr_frames[0] if mfr_frames else 'N/A'} - {mfr_frames[-1] if mfr_frames else 'N/A'} ---")
    print(f"Input MFR (t/h): {input_mfr_metrics['average_mfr_t_h']:.4e}")
    print(f"Exit MFR (t/h):  {exit_mfr_metrics['average_mfr_t_h']:.4e}")
    print("-" * 50)

    # 4. Prepare DataFrames for Output (Full set of frames)
    
    # Create the DataFrame for particle Y-values (using ALL EXIT data)
    df_y_values = pd.DataFrame.from_dict(data_exit_y_values, orient='index').transpose()
    
    # Create particle counts series from ALL EXIT data for the top row
    all_particle_counts = df_y_values.count().rename("Particle Count Below Exit Threshold")
    
    # Create the Summary DataFrame
    summary_data = {
        'Description': [
            f'MFR Calculation Frame Range (Start-End)',
            'Time for MFR Calculation (s)',
            '',
            '-- INPUT MASS FLOW RATE --',
            f'Input Threshold Y-Value (m)',
            'Particles Entered in Frame Range (Total $\Delta$)',
            f'Accumulated Particles Below Input Threshold at END_FRAME', 
            'Input MFR (kg/s)',
            'Input MFR (t/h)',
            '',
            '-- EXIT MASS FLOW RATE --',
            f'Exit Threshold Y-Value (m)',
            'Particles Passed in Frame Range (Total $\Delta$)',
            f'Accumulated Particles Below Exit Threshold at END_FRAME', 
            'Exit MFR (kg/s)',
            'Exit MFR (t/h)'
        ],
        'Value': [
            f'{mfr_frames[0] if mfr_frames else "N/A"} - {mfr_frames[-1] if mfr_frames else "N/A"}', 
            input_mfr_metrics['time_for_mfr'],
            '',
            '',
            y_threshold_input,
            input_mfr_metrics['total_particles_passed_in_range'],
            input_mfr_metrics['accumulated_count_end'], 
            input_mfr_metrics['average_mfr_kg_s'],
            input_mfr_metrics['average_mfr_t_h'],
            '',
            '',
            y_threshold_exit,
            exit_mfr_metrics['total_particles_passed_in_range'],
            exit_mfr_metrics['accumulated_count_end'], 
            exit_mfr_metrics['average_mfr_kg_s'],
            exit_mfr_metrics['average_mfr_t_h']
        ]
    }
    df_summary = pd.DataFrame(summary_data)

    # Combine particle counts with the y-values DataFrame
    df_y_values = pd.concat([pd.DataFrame(all_particle_counts).transpose(), df_y_values])
    df_y_values.iloc[0] = df_y_values.iloc[0].astype(int)
    
    df_y_values = df_y_values.rename(index={df_y_values.index[0]: f'Particles Below Y={y_threshold_exit} (Exit)'})

    # 6. Excel Output
    output_filename = os.path.join(folder_path, "MFR_Input_Output_Analysis_Results.xlsx")
    
    try:
        with pd.ExcelWriter(output_filename, engine='xlsxwriter') as writer:
            # Write the Summary Data
            df_summary.to_excel(writer, sheet_name='MFR Input_Output Analysis', startrow=0, startcol=0, header=False, index=False)
            
            # Add a separator and description
            desc_df = pd.DataFrame({
                'A': [f"--- Y-Values Below EXIT Threshold (Y={y_threshold_exit}) (All Frames) ---"],
                'B': ["Y-values are sorted, with NaN padding where count is less than max count."]
            })
            desc_df.to_excel(writer, sheet_name='MFR Input_Output Analysis', startrow=18, startcol=0, header=False, index=False)
            
            # Write the Frame Data (Counts and Sorted Y-Values for ALL EXIT frames)
            df_y_values.to_excel(writer, sheet_name='MFR Input_Output Analysis', startrow=20, startcol=0, index=True)
            
        print(f"\n✅ Analysis complete. Results saved to: {output_filename}")
        return True
        
    except Exception as e:
        print(f"Error saving to Excel: {e}")
        return False


# --- Execution ---
if __name__ == '__main__':
    success = calculate_mass_flow_rate_from_vtk(
        folder_to_analyze, 
        Y_THRESHOLD_EXIT, 
        Y_THRESHOLD_INPUT,
        PARTICLE_DENSITY, 
        PARTICLE_RADIUS, 
        TIME_PER_FRAME,
        START_FRAME,
        END_FRAME
    )
    if not success:
        print("Script failed to complete successfully.")
